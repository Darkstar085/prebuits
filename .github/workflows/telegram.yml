name: Telegram Delivery

on:
  workflow_run:
    workflows: ["Build and Release"]
    types: [completed]

concurrency:
  group: prebuilts-telegram-${{ github.ref }}
  cancel-in-progress: true

jobs:
  send-telegram:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    env:
      TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      API_ID: ${{ secrets.TELEGRAM_API_ID }}
      API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
      SESSION: ${{ secrets.TELEGRAM_SESSION }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v5

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip jq
          pip3 install pyrogram tgcrypto telethon

      - name: Determine release tag
        run: echo "TAG=prebuilts-${{ github.event.workflow_run.id }}" >> $GITHUB_ENV

      - name: Get release assets
        run: |
          url="https://api.github.com/repos/${{ github.repository }}/releases/tags/${TAG}"
          resp=$(curl -s -H "Accept: application/vnd.github+json" "$url" || true)
          if [ -z "$resp" ] || echo "$resp" | grep -q '"Not Found"'; then exit 0; fi
          echo "$resp" | jq -r '.assets[] | 
            select(.name|test("_v.*\\.(apk|exe)$")) |
            [.name, .browser_download_url] | @tsv' > urls.tsv
          if [ ! -s urls.tsv ]; then exit 0; fi

      - name: Download APPs
        if: success() && hashFiles('urls.tsv') != ''
        run: |
          mkdir -p dl
          while IFS=$'\t' read -r name url; do
            curl -L -o "dl/$name" "$url"
          done < urls.tsv

      - name: Upload to Telegram
        if: success() && hashFiles('dl/*') != ''
        run: |
          python3 .github/scripts/upload.py