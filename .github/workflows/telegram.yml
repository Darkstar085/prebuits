name: Telegram Delivery

on:
  workflow_run:
    workflows: ["Build and Release"]
    types: [completed]

concurrency:
  group: prebuilts-telegram-${{ github.ref }}
  cancel-in-progress: true

jobs:
  send-telegram:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    env:
      TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      API_ID: ${{ secrets.TELEGRAM_API_ID }}
      API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
      SESSION: ${{ secrets.TELEGRAM_SESSION }}

    steps:
      - name: Determine release tag from triggering run
        id: tag
        run: echo "TAG=prebuilts-${{ github.event.workflow_run.id }}" >> $GITHUB_ENV

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Get release assets (APK URLs)
        id: assets
        run: |
          set -e
          url="https://api.github.com/repos/${{ github.repository }}/releases/tags/${TAG}"
          resp=$(curl -sSf \
            -H "Accept: application/vnd.github+json" \
            "$url" || true )
          if echo "$resp" | grep -q '"Not Found"'; then
            echo "Release for tag ${TAG} not found (probably no updates). Exiting."
            echo "NO_APKS=1" >> $GITHUB_ENV
            exit 0
          fi
          echo "$resp" | jq -r '.assets[] | select(.name|test("_v.*\\.apk$")) | [.name, .browser_download_url] | @tsv' > urls.tsv
          if [ ! -s urls.tsv ]; then
            echo "No APK assets found on release ${TAG}. Exiting."
            echo "NO_APKS=1" >> $GITHUB_ENV
            exit 0
          fi

      - name: Exit if no APKs
        if: env.NO_APKS == '1'
        run: echo "Nothing to send."

      - name: Download APKs from release
        if: env.NO_APKS != '1'
        run: |
          mkdir -p dl
          while IFS=$'\t' read -r name url; do
            echo "Downloading $name"
            curl -L -o "dl/$name" "$url"
          done < urls.tsv
          ls -lh dl || true

      - name: Generate tg_captions.tsv from changelogs folder (with static descriptions)
        if: env.NO_APKS != '1'
        run: |
          declare -A app_desc=(
            ["Via"]="Via Browser - Simple, lightweight & highly customizable Android browser"
            ["DotGallery"]="DotGallery - Jetpack Compose-based Android photo gallery app"
            ["DuckDuckGo"]="DuckDuckGo - Private, tracker-blocking browser for Android"
            ["Fossify_Keyboard"]="Keyboard (Fossify) - Open, privacy-friendly keyboard for Android"
            ["ReVanced_GooglePhotos"]="Google Photos (ReVanced) - Patched Google Photos with extra features"
            ["ReVanced_YouTube"]="YouTube (ReVanced) - Patched YouTube with ad-block and tweaks"
            ["ReVanced_YTMusic"]="YouTube Music (ReVanced) - Patched YT Music with extra features"
            ["Spotify_Revanced"]="Spotify (ReVanced) - Modded Spotify with more controls"
            ["ReVanced_MicroG"]="ReVanced MicroG - Bridges ReVanced apps with Google sign-in"
            ["WeatherMaster"]="WeatherMaster - Modern weather app with powerful graphs & details"
            ["MicroG_RE"]="MicroG RE - MicroG fork with improved Play Services emulation"
            ["Cromite"]="Cromite - Bromite-based browser focused on privacy & ad-blocking"
            ["Symphony"]="Symphony - Elegant, lightweight music player for Android 9+"
          )
          rm -f tg_captions.tsv
          shopt -s nullglob
          for apk in dl/*_v*.apk; do
            FILE=$(basename "$apk")
            APP="${FILE%%_v*}"
            VERSION=$(echo "$FILE" | sed -E 's/.*_v(.*)\.apk/\1/')
            DESC="${app_desc[$APP]:-No description available}"

            CHANGELOG_FILE="changelogs/${APP}.txt"
            if [ -f "$CHANGELOG_FILE" ]; then
              CHANGELOG=$(awk '/^### Version v'"$VERSION"'/,/^### Version v/{if(NR!=1)print}' "$CHANGELOG_FILE" | sed '$d' | sed '/^$/d')
              [ -z "$CHANGELOG" ] && CHANGELOG="Developer doesn't provided any updated info"
            else
              CHANGELOG="Developer doesn't provided any updated info"
            fi

            CAPTION="${DESC}\n\n${APP} updated to v${VERSION}\nChangelog:\n${CHANGELOG}"
            echo -e "${FILE}\t${CAPTION}" >> tg_captions.tsv
          done

      - name: Upload small APKs via bot (â‰¤48MB, with captions)
        if: env.NO_APKS != '1'
        run: |
          set -e
          shopt -s nullglob
          while IFS=$'\t' read -r APK CAPTION; do
            SIZE_MB=$(( ( $(stat -c%s "dl/$APK") + 1048575 ) / 1048576 ))
            if [ "$SIZE_MB" -le 48 ]; then
              curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendDocument" \
                -F chat_id=${TELEGRAM_CHAT_ID} \
                -F document=@"dl/$APK" \
                -F caption="$CAPTION" \
                -F parse_mode=HTML >/dev/null
            fi
          done < tg_captions.tsv

      - name: Set up Python
        if: env.NO_APKS != '1'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Telethon
        if: env.NO_APKS != '1'
        run: pip install telethon

      - name: Upload large APKs via user (>48MB, with captions)
        if: env.NO_APKS != '1'
        env:
          CHAT_ID: ${{ env.TELEGRAM_CHAT_ID }}
        run: |
          python - <<'PY'
          import os, glob, asyncio
          from telethon import TelegramClient
          from telethon.sessions import StringSession
          from asyncio import Semaphore

          api_id = int(os.environ['API_ID'])
          api_hash = os.environ['API_HASH']
          session = os.environ['SESSION']
          chat_id = os.environ['CHAT_ID']
          chat = chat_id if not chat_id.lstrip('-').isdigit() else int(chat_id)

          captions = {}
          with open('tg_captions.tsv', 'r', encoding='utf-8') as f:
              for line in f:
                  parts = line.strip('\n').split('\t', 1)
                  if len(parts) == 2:
                      captions[parts[0]] = parts[1]

          files = sorted(glob.glob('dl/*_v*.apk'))
          files = [f for f in files if os.path.getsize(f) > 48 * 1024 * 1024]
          if not files:
              raise SystemExit(0)

          sem = Semaphore(2)
          async def send_one(client, f):
              async with sem:
                  caption = captions.get(os.path.basename(f), "")
                  await client.send_file(chat, f, force_document=True, caption=caption[:1024])

          async def main():
              async with TelegramClient(StringSession(session), api_id, api_hash) as client:
                  await asyncio.gather(*(send_one(client, f) for f in files))

          asyncio.run(main())
          PY